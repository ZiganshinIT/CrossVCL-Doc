## Портирование посредством Cross VCL

**CrossVCL** — это набор инструментов для разработчиков Delphi, которые позволяют создавать приложения VCL для MacOS и Linux.

CrossVCL охватывает только пользовательскую часть интерфейса WinAPI (кроме DirectX). Для части приложения, не связанных с пользовательским интефйесом, необходимо использовать кроссплатформенные процедуры и функции.

#### Требования
`Для MacOS`:  
Embarcodero Delphi версии >= 10.3 с компилятором macOS.

`Для Linux`:  
*Копоративная* версия Embarcodero Delphi версии > 10.3.

32-разрядная версия macOS: не поддерживается с версии CrossVcl 1.19.  
64-разрядная версия macOS: Embarcadero Rio или выше.  
64-разрядная версия Linux: Embarcadero Rio или выше.  

#### Уставновка

Установить CrossVCL можно с [официального сайта](https://crossvcl.com/), следуя всем инструкциям.

Откройте проект и щелкните правой кнопкой на название проекта в Инспекторе проектов и выберите `Add New Platform`.
    
Платформу можно переключить в Инспекторе проектов выбрав необходимую в раскрывающимся списке `Target Platforms`.

#### Настройка

Для компиляции под интересующую плафторму необходима удалленную система с уставноленой на ней PAServer (Platform Assistant Server).

##### На удаленной системе

Для соединения системы должны находились в одной сети. Если используется система из `VirtualBox` необходимо выбрать `Сетевой мост` в качестве типа подключения. Это можно сделать в
```
Настройки -> Сеть
```

Скачать `bash-скрипт` и запустить в домашней диретории командой
```
> bash install.sh
```
После устанвоки запустить PAServer командой
```
> bash ~/pa22.sh
```
и нажать Enter.

##### В текущей системе

В текущей системе необходимо создать `Connection Profile`. Для этого необходимо перейти  
```
Tools -> Options -> Deployment -> Connection Profile Manager
```
и нажать кнопку `Add...`.

В открывшемя окне указать Имя нового соединения и Тип платформы.
Далее необходимо ввести IP-адрес удаленной системы, который можно получить введя в командной строке, где запущен PAServer, ключ `i`:

```
Starting Platform Assistant Server on port 64211

Type ? for available commands
>i
192.168.1.0
```

Проверить соединение с помощью `Test Connection` и сохранить соединение в случае удачи.

Следующим шагом является создание `SDK`.  

Комплект разработки программного обеспечения (`SDK`) предоставляет программное обеспечение, необходимое для создания приложений для целевой платформы.

Для добавления `SDK` необходимо перейти
```
Tools -> Options -> Deployment -> SDK Manager
```

и нажать `Add...`

Здесь необходимо указать нужную платформу и выбрать необходимый профиль соединения, если их несколько. Версию SDK можно оставить по умолчанию.

#### Доступ к сторонним файлам и динамическим библиотекам.

Для добавления сторониих файлов (картинок, курсоров и т.д.) и динамических библиотек, необходимо перейти
```
Project -> Deployment
```

Файлы добавленные сюда будут с каждой компиляцией загрузаться на удаленную систему.

Важно: указать в столбце `Remote Path` путь относительно файла проекта.

Динамические библеотеки на Linux имеют расширение `.so`, на MacOS `.lib`.

Теперь можно компилировать проект.

#### Ошибки и их решения

##### CrossVCL не поддерживает `CustomTitleBar`
В Object Inspector необходимо отключить свойства `CustomTitleBar`, это можно сделать указав `False` в подсвойстве Enable.

##### CrossVCL не поддерживае код на Assembler
Функции и процедуру использующие язык ассембера небходимо пометить директивой `{%IFDEF MSWINDOWS} {$ENDIF}` или переписать посредством языка Delphi.

##### Ошибка [DCC Error] E2597 C:\Program Files (x86)\CrossVcl\Lib\22.0\Linux64\Debug\Winapi.Windows.o:Winapi.Windows:function Winapi::Windows::OpenFileMapping(unsigned int, int, char16_t*): error: undefined reference to 'OpenFileMappingW'
Готоврит о том что CrossVCL не поддерживает функцию OpenFileMappingW.
